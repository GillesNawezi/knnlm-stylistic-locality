"""
How to Fine Tune
-Same srcdict as in the pretrained model
-Use --restore-file to reload the checkpoint
-use the same architecture
-use --reset-dataloader
"""

cd examples/language_model/
bash prepare-wikitext-103.sh
cd ../..

## preprocess
TEXT=examples/language_model/style_category_dataset
python preprocess.py \
    --only-source \
    --srcdict data-bin/wikitext-103/dict.txt \
    --trainpref $TEXT/train.txt \
    --validpref $TEXT/valid.txt \
    --testpref $TEXT/test.txt \
    --destdir data-bin/style_category_fine_tune \
    --workers 20

# Fine Tune wiki 103
CUDA_VISIBLE_DEVICES=3 python train.py --task language_modeling \
    data-bin/style_category_wiki_fine_tune \
    --save-dir checkpoints/style_category_wiki_fine_tune \
    --arch transformer_lm_wiki103  \
    --max-epoch 100 --max-lr 1.0 --t-mult 2 --lr-period-updates 270000 --lr-scheduler cosine --lr-shrink 0.75 \
    --warmup-updates 16000 --warmup-init-lr 1e-07 --min-lr 1e-09 --optimizer nag --lr 0.0001 --clip-norm 0.1 \
    --criterion adaptive_loss --max-tokens 1024 --update-freq 3 --tokens-per-sample 1024 --seed 1  \
    --sample-break-mode none --skip-invalid-size-inputs-valid-test --ddp-backend=no_c10d --keep-interval-updates 3  


## eval lm, valid
python eval_lm.py data-bin/style_category_dataset \
    --path checkpoints/style_category_wiki_fine_tune/checkpoint_best.pt \
    --sample-break-mode eos --max-tokens 3072 \
    --softmax-batch 1024 \
    --gen-subset valid

## eval lm, valid
python eval_lm.py data-bin/style_category_dataset \
    --path checkpoints/style_category_wiki_fine_tune/checkpoint_best.pt \
    --sample-break-mode eos --max-tokens 3072 \
    --softmax-batch 1024 \
    --gen-subset valid

## eval lm, Wikitext
python eval_lm.py data-bin/wikitext103_seg \
    --path checkpoints/style_category_wiki_fine_tune/checkpoint_best.pt \
    --sample-break-mode eos --max-tokens 3072 \
    --softmax-batch 1024 \
    --gen-subset valid

#generate samples
fairseq-interactive data-bin/wikitext103_seg \
--task language_modeling \
--path checkpoints/style_category_wiki_fine_tune/checkpoint_best.pt \
#--beam 5